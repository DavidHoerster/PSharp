<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="generator" content="Madoko, version 0.9.5-beta" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="author" content="Akash Lal" />
  <title>The P# Tutorial</title>
  <style  class="link">
  /* ---------------------------------------------------
     Various settings to display madoko elements correctly.
     For example, lines in tables or a table of contents.
  
     All rules use specific madoko classes and never just
     a generic element. This means one can safely include
     this CSS into any web page without affecting non-madoko
     content.
  ----------------------------------------------------*/
  
  /* The table of  contents */
  .madoko .toc>.tocblock .tocblock .tocblock {
    margin-left: 2.5em;
  }
  
  .madoko .toc>.tocblock .tocblock {
    margin-left: 1.7em;
  }
  
  .madoko .toc>.tocblock>.tocitem {
    font-weight: bold;
  }
  
  .madoko .toc {
    margin-top: 1em;
  }
  
  /* Paragraphs */
  .madoko p.para-continue {
    margin-bottom: 0pt;
  }
  
  .madoko .para-block+p {
    margin-top: 0pt;
  }
  
  .madoko ul.para-block, .madoko ol.para-block {
    margin-top: 0pt;
    margin-bottom: 0pt;
  }
  
  .madoko ul.para-end, .madoko ol.para-end {
    margin-bottom: 1em;
  }
  
  .madoko dl {
    margin-left: 0em;
  }
  
  .madoko blockquote {
    font-style: italic;
  }
  
  /* Local page links do not get an underline unless hovering */
  .madoko a.localref {
    text-decoration: none;
  }
  .madoko a.localref:hover {
    text-decoration: underline;
  }
  
  /* Footnotes */
  .madoko .footnotes {
    font-size: smaller;
    margin-top: 2em;
  }
  
  .madoko .footnotes hr {
    width: 50%;
    text-align: left;
  }
  
  .madoko .footnote { 
    margin-left: 1em;
  }
  .madoko .footnote-before {
    margin-left: -1em;
    width: 1em;
    display: inline-block;
  }
  
  /* Abstract */
  .madoko .abstract>p:first-child:before {
    content: "Abstract. ";
    font-weight: bold;
  }
  
  .madoko .abstract {
    margin-left: 2.7em;
    margin-right: 2.7em;
    font-size: small;
  }
  
  
  /* Alignment */
  .madoko .align-center, .madoko .align-center>p {
    text-align: center !important;
  }
  
  .madoko .align-center pre {
    text-align: left;
  }
  
  .madoko .align-center>* {
    margin-left: auto !important;
    margin-right: auto !important;
  }
  
  .madoko .align-left, .madoko .align-left>p {
    text-align: left !important;
  }
  
  .madoko .align-left>* {
    margin-left: 0pt !important;
    margin-right: auto !important;
  }
  
  .madoko .align-right, .madoko .align-right>p {
    text-align: right !important;
  }
  
  .madoko .align-right>* {
    margin-left: auto !important;
    margin-right: 0pt !important;
  }
  
  .madoko .align-center>table,
  .madoko .align-left>table,
  .madoko .align-right>table {
    text-align: left !important;
  }
  
  
  /* Equations, Figure's etc. */
  .madoko .equation-before {
    float: right;
  }
  
  
  /* Bibliography */
  .madoko .bibitem {
    font-size: smaller;
  }
  
  .madoko .bib-numeric .bibitem {
    margin-left: 3em;
    text-indent: -3em;
  }
  
  .madoko .bibitem-before {
    display: none;
  }
  
  .madoko .bib-numeric .bibitem-before {
    display: inline-block;
    width: 3em;
    text-align: right;
  }
  
  .madoko .bibliography {
  }
  
  .madoko .bibsearch {
    font-size: x-small;
    text-decoration:none;
    color: black;
    font-family: "Segoe UI Symbol", Symbola;
  }
  
  /* General */
  .madoko .block, .madoko .figure, .madoko .bibitem, .madoko .equation, .madoko div.math {
    margin-top: 1ex;
    margin-bottom: 1ex;
  }
  
  .madoko .figure {
    padding: 0.5em;
    margin-left: 0pt;
    margin-right: 0pt;
  }
  
  .madoko .hidden {
    display: none;
  }
  
  .madoko .invisible {
    visibility: hidden;
  }
  
  .madoko.preview .invisible {
    visibility: visible;
    opacity: 0.5;
  }
  
  .madoko code.code, .madoko span.code {
    white-space: pre-wrap;
  }
  
  .madoko hr, hr.madoko {
    border: none;
    border-bottom: black solid 1px;
    margin-bottom: 0.5ex;
  }
  
  .madoko .framed>*:first-child {
    margin-top: 0pt;
  }
  .madoko .framed>*:last-child {
    margin-bottom: 0pt;
  }
  
  
  /* Title, authors */
  /*
  .madoko .title {
    font-size: xx-large;
    font-weight: bold;
    margin-bottom: 1ex;
  }
  
  .madoko .subtitle {
    font-size: x-large;
    margin-bottom: 1ex;
    margin-top: -1ex;
  }
  
  .madoko .titleblock>* {
    margin-left: auto;
    margin-right: auto;
    text-align: center;
  }
  
  .madoko .titleblock table {
    width: 80%;
  }
  
  .madoko .authorblock .author {
    font-size: large;
  }
  
  .madoko .titlenote {
    margin-top: -0.5ex;
    margin-bottom: 1.5ex;
  }
  */
  
  /* Lists */
  
  .madoko ul.list-star {
    list-style-type: disc;
  }
  
  .madoko ul.list-dash {
      list-style-type: none !important;
  }
  
  .madoko ul.list-dash > li:before {
      content: "\2013"; 
      position: absolute;
      margin-left: -1em; 
  }
  
  .madoko ul.list-plus {
    list-style-type: square;
  }
  
  /* Tables */
  .madoko table.madoko {
    border-collapse: collapse;
  }
  .madoko td, .madoko th {
    padding: 0ex 0.5ex;
    margin: 0pt;
    vertical-align: top;
  }
  
  .madoko .cell-border-left {
    border-left: 1px solid black;
  }
  .madoko .cell-border-right {
    border-right: 1px solid black;
  }
  
  
  .madoko thead>tr:first-child>.cell-line,
  .madoko tbody:first-child>tr:first-child>.cell-line {
    border-top: 1px solid black;
    border-bottom: none;
  }
  
  .madoko .cell-line, .madoko .cell-double-line {
    border-bottom: 1px solid black;
    border-top: none;
  }
  
  .madoko .cell-double-line {
    border-top: 1px solid black;
    padding-top: 1.5px !important;
  }
  
  
  /* Math Pre */
  .madoko .input-mathpre .MathJax_Display {
    text-align: left !important;
  }
  
  .madoko div.input-mathpre {
    text-align: left;
    margin-top: 1.5ex;
    margin-bottom: 1ex;
  }
  
  .madoko .math-rendering {
    color: gray;
  }
  
  /* Math */
  .madoko .mathdisplay {
    text-align: center;
  }
  
  
  /*---------------------------------------------------------------------------
    Default style for syntax highlighting
  ---------------------------------------------------------------------------*/
  
  .highlighted                        { color: black; }
  .highlighted .token.identifier      { }
  .highlighted .token.operators       { }
  .highlighted .token.keyword         { color: blue }
  .highlighted .token.string          { color: maroon } 
  .highlighted .token.string.escape   { color: gray }
  .highlighted .token.comment         { color: darkgreen }
  .highlighted .token.comment.doc     { font-style: normal }
  .highlighted .token.constant        { color: purple; }
  .highlighted .token.entity          {  }
  .highlighted .token.tag             { color: blue }
  .highlighted .token.info-token      { color: black }
  .highlighted .token.warn-token      { color: black }
  .highlighted .token.error-token     { color: darkred }
  .highlighted .token.debug-token     { color: gray }
  .highlighted .token.regexp          { color: maroon }
  .highlighted .token.attribute.name  { color: navy }
  .highlighted .token.attribute.value { color: maroon }
  .highlighted .token.constructor     { color: purple }
  .highlighted .token.namespace       { color: navy }
  .highlighted .token.header          { color: navy }
  .highlighted .token.type            { color: teal } 
  .highlighted .token.type.delimiter  { color: teal; } 
  .highlighted .token.predefined      { color: navy }
  .highlighted .token.invalid         { border-bottom: red dotted 1px }
  .highlighted .token.code            { color: maroon }
  .highlighted .token.code.keyword    { color: navy }
  .highlighted .token.typevar         { font-style: italic; }
  
  .highlighted .token.delimiter   {  } /* .[curly,square,parenthesis,angle,array,bracket] */
  .highlighted .token.number      {  }    /* .[hex,octal,binary,float] */
  .highlighted .token.variable    {  }  /* .[name,value]  */
  .highlighted .token.meta        { color: navy }      /* .[content] */
  
  .highlighted .token.bold            { font-weight: bold; }
  .highlighted .token.italic          { font-style: italic; }
  
  
  /* Pretty formatting of code */
  .madoko pre.pretty, .madoko code.pretty { 
    font-family: Cambria,Times,Georgia,serif;
    font-size: 100%;
  }
  
  .madoko .pretty table {
    border-collapse: collapse;
  }
  .madoko .pretty td {
    padding: 0em;
  }
  .madoko .pretty td.empty {
    min-width: 1.5ex;
  }
  .madoko .pretty td.expander {
    width: 100em;
  }
  .madoko .pretty .token.identifier         { font-style: italic }
  .madoko .pretty .token.constructor        { font-style: italic }
  
  
  /* ---------------------------------------------------
     Styling for full documents
  ----------------------------------------------------*/
  body.madoko {
    font-family: Cambria,"Times New Roman","Liberation Serif","Times",serif;
    -webkit-text-size-adjust: 100%; /* so math displays well on mobile devices */
  }
  
  body.madoko {
    max-width: 88ex; /* about 88 characters */
    margin: 1em auto;
    padding: 0em 2em;  
  }
  
  body.preview.madoko {
    padding: 0em 1em;
  }
  
  .madoko p,
  .madoko li {
    text-align: justify;
  }
  
  /* style headings nicer, especially h5 and h6 */
  .madoko h1, .madoko h2, .madoko h3, .madoko h4 { 
    margin-top: 1.22em; 
    margin-bottom: 1ex;
  }
  .madoko h1+p, .madoko h2+p, .madoko h3+p, .madoko h4+p, .madoko h5+p  { 
    margin-top: 1ex;    
  }
  .madoko h5, .madoko h6 { 
    margin-top: 1ex;
    font-size: 1em;
  }
  .madoko h5 { 
    margin-bottom: 0.5ex;
  }
  .madoko h5 + p {
    margin-top: 0.5ex;
  }
  .madoko h6 { 
    margin-bottom: 0pt;
  }
  .madoko h6 + p {
    margin-top: 0pt;
  }
  
  
  /* Fix monospace display (see http://code.stephenmorley.org/html-and-css/fixing-browsers-broken-monospace-font-handling/) */
  .madoko pre, .madoko code, .madoko kbd, .madoko samp, .madoko tt, .madoko .monospace, .madoko .token.indent, .madoko .reveal pre, .madoko .reveal code, .madoko .email {
    font-family: Consolas,"Andale Mono WT","Andale Mono",Lucida Console,Monaco,monospace,monospace;
    font-size: 0.85em;
  }
  .madoko pre code, .madoko .token.indent {
    font-size: 0.95em;
  }
  
  .madoko pre code {
    font-family: inherit !important;
  }
  
  /* Code prettify */
  .madoko ol.linenums li {
    background-color: white;
    list-style-type: decimal;
  }
  
  /* Merging */
  .madoko .remote {
    background-color: #F0FFF0;
  }
  .madoko .remote + * {
    margin-top: 0pt;
  }
  
  /* ---------------------------------------------------
     Print settings
  ----------------------------------------------------*/
  
  @media print {
    body.madoko {
      font-size: 10pt;
    }
    @page {
      margin: 1in 1.5in;
    }
  }
  
  /* ---------------------------------------------------
     Mobile device settings
  ----------------------------------------------------*/
  
  @media only screen and (max-device-width:1024px) {
    body.madoko {
      padding: 0em 1em;
    }
  }
  
    </style>
  
  <style>
    body { text-rendering: optimizeLegibility }
  </style>
  </head>
<body class="madoko">

<div class="body madoko" style="line-adjust:0">

<div class="titleblock align-center para-block" style="line-adjust:0">
<div class="titleheader align-center" style="line-adjust:0">
<div class="title para-block" style="font-size:xx-large;font-weight:bold;margin-bottom:0.5ex;line-adjust:0">The P# Tutorial</div></div>
<div class="authors align-center" style="width:80%;line-adjust:0"><table class="authorrow columns block" style="margin-top:2ex;width:100%;line-adjust:0">
<tbody><tr><td class="author column" style="text-align:center;line-adjust:0">
<div class="authorname" style="font-size:large;line-adjust:0">Pantazis Deligiannis</div>
<div class="authoremail email" style="line-adjust:0">p.deligiannis@imperial.ac.uk</div></td><td class="author column" style="text-align:center;line-adjust:0">
<div class="authorname" style="font-size:large;line-adjust:0">Shaz Qadeer</div>
<div class="authoremail email" style="line-adjust:0">qadeer@microsoft.com</div></td><td class="author column" style="text-align:center;line-adjust:0">
<div class="authorname" style="font-size:large;line-adjust:0">Akash Lal</div>
<div class="authoremail email" style="line-adjust:0">akashl@microsoft.com</div></td></tr></tbody></table></div></div><h2 id="sec-introduction"   style="font-weight:normal;bookmark:1.&#8194;Introduction"><span class="heading-before"><span class="heading-label">1</span>.&#8194;</span>Introduction</h2>
<p>P# is an actor-based programming language for develoPing highly-reliable event-driven
asynchronous .NET applications. The computational model underlying a P# program is
<em>communicating state-machines</em> (similar concept to actors). P# machines communicate
by sending and receiving <em>events</em>, an approach commonly used in building embedded,
networked, and distributed systems. P# is an extension of the C# language: it
provides new language primitives for creating machines and sending events from a
machine to another. Because P# is built on top of C#, the programmer can blend P# and
C# code: this not only lowers the overhead of learning a new language, but also
allows P# to easily integrate with existing .NET projects.
</p>
<p class="indent">In P#, machines are first class citizens of the language (similar to how classes are
first class citizens in C#). Each machine has an input queue, states, transitions,
event handlers, fields and methods. Machines run concurrently with each other, each
executing an event handling loop that dequeues an event from the input queue and
handles it by executing a sequence of operations. Each operation might update a field,
create a new machine, or send an event to another machine. In P#, a send operation is
non-blocking; the message is simply enqueued into the input queue of the target machine.
</p>
<p class="indent">In the rest of this tutorial, we will introduce the features of P# through a series of
examples.
We will first present a simple program (Section&nbsp;<a href="#sec-simple-program" title="2.&#8194;A simple P# program" class="localref" style="target-element:h1"><span class="heading-label">2</span></a>) that illustrates
the basic features of the P# state-machine programming model.
Next, we present a more advanced example (Section&nbsp;<a href="#sec-advanced-features" title="3.&#8194;Advanced P# features" class="localref" style="target-element:h1"><span class="heading-label">3</span></a>) that illustrates
advanced features of the P# language.
Finally, we will provide an overview of the tools for compiling and systematically testing
a P# program (Section&nbsp;<a href="#sec-tools" title="4.&#8194;Tools" class="localref" style="target-element:h1"><span class="heading-label">4</span></a>) and conclude with a glossary of all P#-specific
features in our language (Section&nbsp;<a href="#sec-glossary" title="5.&#8194;Glossary" class="localref" style="target-element:h1"><span class="heading-label">5</span></a>).
</p><h2 id="sec-simple-program"   style="font-weight:normal;bookmark:2.&#8194;A simple P# program"><span class="heading-before"><span class="heading-label">2</span>.&#8194;</span>A simple P# program</h2>
<p>A P# program is a collection of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>event</span></code>, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code> and, optionally, other top-level C#
declarations (e.g. <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>class</span></code>). Events and machines must be declared inside a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>psharp</span></code>
file, while C# top-level declarations must be declared in a typical <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>cs</span></code> file.
Similar to C#, all top-level declarations must be declared inside a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>namespace</span></code>.
The following example contains a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine and a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine communicating
with each other via <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> events.
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token comment psharp'>// PingPong.psharp</span><br><span class='token keyword psharp'>namespace</span><span class='token white psharp'> </span><span class='token type identifier psharp'>PingPong</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Server</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>;</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Init</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Client</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Playing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Playing</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPong</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>  </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Client</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token identifier psharp'>server</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>int</span><span class='token white psharp'> </span><span class='token identifier psharp'>counter</span><span class='token delimiter psharp'>;</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Init</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>server</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>counter</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token number psharp'>0</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Playing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Playing</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>counter</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token number psharp'>5</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>server</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>halt</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token keyword psharp'>halt</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Playing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>counter</span>++<span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>server</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>  </span><span class='token keyword psharp'>public</span><span class='token white psharp'> </span><span class='token keyword psharp'>class</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Program</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>static</span><span class='token white psharp'> </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Main</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>string</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token identifier psharp'>args</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token type identifier psharp'>PSharpRuntime</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>CreateMachine</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>typeof</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token type identifier psharp'>Server</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token type identifier psharp'>Console</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ReadLine</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token delimiter curly psharp bracket-close'>}</span></code></pre>
<p>A <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code> declaration contains a collection of field, state and method
declarations. For example, the machine <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> has a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>client</span></code> field, two states,
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code>, and a method <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPong</span></code> declared inside it. The fields and
methods of a machine <em>cannot</em> be public; they can only be accessed locally from a
particular instance of the machine. The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>start</span></code> modifier in the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> state
declaration indicates that an instance of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> begins executing by entering
the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> state.
</p>
<p class="indent">A <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>state</span></code> declaration can optionally contain a number of state-specific declarations.
A code block indicated by <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> { &#8230; } denotes an action that is executed when the
state is entered, while a code block indicated by <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>exit</span></code> { &#8230; } (not used in the
above example) denotes an action that is executed when the state exits.
A P# action (e.g. <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>exit</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPong</span></code>), is a block of arbitrary P# and
C# statements. As an example, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> action in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code>
contains two statements.
The first statement, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Client</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span></code>, creates a new instance
of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine and stores a reference to this instance in the field <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>client</span></code>.
Note that P# allows the use of all the primitive types that C# provides (e.g. <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>int</span></code>
and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>bool</span></code>) and also introduces the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code> type, which is a reference to a
dynamically-created P# machine.
The second statement in the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> action <em>raises</em> an event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Unit</span></code>, which causes
control to exit the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> state and enter the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code> state. When a machine raises
an event, it literally sends an event to itself.
In P#, when a machine raises an event, or sends an event to another machine, the event
is enqueued in the target machine&#39;s input queue. However, a raised event does not go
through the queue; rather it terminates execution of the enclosing code block and is
handled immediately.
</p>
<p class="indent">Other than the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>exit</span></code> declarations, all other declarations inside a
state are related to event handling.
The declaration <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Playing</span></code> in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine
is an example of such a declaration: it indicates that the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Unit</span></code> event must be
handled by exiting the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> and transitioning to the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code>.
The declaration <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPong</span></code> in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine
is another example: it indicates that the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code> event must be handled by invoking
the action <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPong</span></code>. P# also supports <em>anonymous</em> actions: the declaration
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span></code> { &#8230; } in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code> of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine is such an
anonymous action, which states that the code block between the braces must be
executed when <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> is dequeued. When an action executes control remains in the
state subsequent to this execution. This control primitive is useful for executing
an event-driven loop in a state, such as the one in <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code> for collecting
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> responses. Different states of a machine can choose to handle a particular
event in a different way: the programmer is free to decide how an event should be
handled.
</p>
<p class="indent">A P# action can be any C# method that has no parameters. An example of an action is
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPong</span></code>, which contains the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>send</span></code> statement that is responsible for sending
an event (in this case <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code>) to the machine whose address is stored in the field
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>client</span></code>. The keyword <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>this</span></code> refers to the current instance of the machine (in this
case an instance of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine).
</p>
<p class="indent">A machine can optionally send data to another machine, either when creating a machine
(via the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>create</span></code> statement) or when sending an event to a machine (via the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>send</span></code>
statement). Note that both <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>create</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>send</span></code> statements are non-blocking.
In the above example, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine sends a reference to itself (i.e. <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>this</span></code>)
when creating the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine in the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> action of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> state. The
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine can retrieve this data by using the keyword <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>payload</span></code>, as in the
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code> action of the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code>. When a machine receives a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>payload</span></code> it has to
cast the data to its expected type; in this case the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code> type (as it is a
reference to the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine).
</p>
<p class="indent">To start execution of a P# program, the programmer has to create an initial machine
using the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CreateMachine</span></code> method provided by the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>PSharpRuntime</span></code> API. This method
accepts as a parameter the type of the machine to be created (in our case a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code>
machine) and an optional payload (not used in the above example). Because the
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CreateMachine</span></code> method is non-blocking, we use the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Console</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ReadLine</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span></code> statement
so that the program does not exit prematurely. The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>PSharpRuntime</span></code> API also provides
a method for enqueueing events to a P# machine from C# code (not used in the above
example). To do this, the programmer has to use the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendEvent</span></code> method that accepts
as a parameter a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>MachineId</span></code> object, returned when creating a machine via the
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CreateMachine</span></code> method, and an event object.
</p>
<p class="indent">In the above example, the P# program begins with a single instance of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> being
created and then entering state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code>. Let us call this instance of the Server
machine <em>server</em>. Machine <em>server</em> then creates an instance of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine
and raises the event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Unit</span></code> to enter the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code>. Let us call this instance
of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine <em>client</em>. The machine <em>client</em> begins execution when <em>server</em>
is in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code>, then <em>client</em> also transitions to the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Playing</span></code> by
raising a event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Unit</span></code>. From this point on, <em>client</em> and <em>server</em> exchange <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code>
and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> events.
</p>
<p class="indent">The most important safety specification of a P# program is that every event dequeued
by a machine is handled; otherwise, the P# runtime reports an unhandled event error.
The PingPong program satisfies this specification since the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Server</span></code> machine handles
the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code> event and the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine handles the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> event in every state
where an event dequeue is possible.
</p>
<p class="indent">In order to terminate a P# machine cleanly, it must dequeue a special <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code> event.
In this example, after <em>client</em> sends 5 <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code> events to <em>server</em>, it sends <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code>
to <em>server</em> and then raises <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code>.
Termination of a machine due to an unhandled <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code> event is valid behavior (the P#
runtime does not report an error).
From the point of view of formal operational semantics, a halted machine is fully
receptive and consumes any event that is sent to it.
The P# runtime implements this semantics efficiently by cleaning up resources
allocated to a halted machine and recording that the machine has halted.
An event sent to a halted machine is simply dropped.
A halted machine cannot be restarted; it remains halted forever.
</p><h2 id="sec-advanced-features"   style="font-weight:normal;bookmark:3.&#8194;Advanced P# features"><span class="heading-before"><span class="heading-label">3</span>.&#8194;</span>Advanced P# features</h2>
<p>The following example illustrates the more advanced features of the P# language.
This program implements a failure detection protocol. A <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> machine
is given a list of machines, each of which represents a daemon running at a node of
a distributed system. The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> sends each machine in the list a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code>
event and determines whether a machine has failed. A machine has failed if it does
not respond with a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> event within a certain time period. The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code>
uses an operating system timer to implement the bounded wait for the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> event.
</p><h3 id="sec-modeling-a-machine"   style="font-weight:normal;bookmark:3.1.&#8194;Modeling a machine"><span class="heading-before"><span class="heading-label">3.1</span>.&#8194;</span>Modeling a machine</h3>
<p>The code snippet below shows the implementation of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timer</span></code> machine. This machine
is declared using the keyword <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>model</span></code> (instead of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code>) to indicate that it
represents an abstraction of the operating system (OS) timer. This abstraction
<em>substitutes</em> the OS timer and is used to <em>systematically test</em> the interaction of the
failure detector protocol with the underlying OS (see Section&nbsp;<a href="#sec-tools" title="4.&#8194;Tools" class="localref" style="target-element:h1"><span class="heading-label">4</span></a>).
During execution of a P# program, model machines are <em>replaced</em> by their actual
implementations; a model machine is used only for systematic testing.
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token comment psharp'>// Timer.psharp</span><br><span class='token keyword psharp'>namespace</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// events from client to timer</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Start</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Cancel</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// events from timer to client</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelSuccess</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelFailure</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// local event for control transfer within timer</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><br><br><span class='token white psharp'>  </span><span class='token keyword psharp'>model</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timer</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Init</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token comment psharp'>// goto handler of Unit</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>        </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForReq</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForReq</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Cancel</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForReq</span><span class='token white psharp'> </span><span class='token keyword psharp'>with</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelFailure</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Start</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForCancel</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForCancel</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>ignore</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Start</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Cancel</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForReq</span><span class='token white psharp'> </span><span class='token keyword psharp'>with</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>$</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelSuccess</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token white psharp'> </span><span class='token keyword psharp'>else</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelFailure</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token keyword psharp'>default</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForReq</span><span class='token white psharp'> </span><span class='token keyword psharp'>with</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>client</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token delimiter curly psharp bracket-close'>}</span></code></pre>
<p>Each instance of a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timer</span></code> machine has a reference to a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Client</span></code> machine instance,
stored in the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>client</span></code> field. This client sends <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Start</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Cancel</span></code> events to the
timer, which subsequently responds with <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code>, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelSuccess</span></code>, or <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelFailure</span></code>
events.
</p>
<p class="indent">The timer has three states: <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code>, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForReq</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancel</span></code>. It starts
executing in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code>, where it initializes the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>client</span></code> field with the
machine reference obtained by accessing <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>payload</span></code> and casting it to the type
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code>. It then waits in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForReq</span></code> for a request from the client,
responding with <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelFailure</span></code> to a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Cancel</span></code> event and moving to the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancel</span></code>
state on a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Start</span></code> event.
</p>
<p class="indent">The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>ignore</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Start</span></code> declaration inside the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancel</span></code> state of the timer denotes
that whenever the event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Start</span></code> is dequeued it must be dropped without taking any
further action.
</p>
<p class="indent">The response to a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Cancel</span></code> event involves the use of nondeterminism to model the
race condition between the arrival of a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Cancel</span></code> event from the client and the
elapse of the timer. This nondeterminism is indicated by an <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>if</span></code> statement guarded
by the keyword <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>$</span></code>, which returns a nondeterminitic boolean choice.
The then-branch models the case when the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Cancel</span></code> event arrives before the timer
elapses; in this case, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelSuccess</span></code> is sent back to the client.
The else-branch models the case when the timer fires before the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Cancel</span></code> event
arrives; in this case, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelFailure</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code> are sent back to the client
one after another. The last event handler <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token keyword psharp'>default</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForReq</span><span class='token white psharp'> </span><span class='token keyword psharp'>with</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><span class='token white psharp'> </span><span class='token delimiter psharp'>.</span><span class='token delimiter psharp'>.</span><span class='token delimiter psharp'>.</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-close'>}</span></code>
transfers the control to the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForReq</span></code> state, modeling that the timer has elapsed,
if neither of the other event handlers in <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancel</span></code> can execute. The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>with</span></code>
statement block executes after the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>exit</span></code> action of the exiting state.
The event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>default</span></code> is a special event that is internally generated by the P#
runtime.
</p><h3 id="sec-substitution"   style="font-weight:normal;bookmark:3.2.&#8194;Substitution"><span class="heading-before"><span class="heading-label">3.2</span>.&#8194;</span>Substitution</h3>
<p>A machine can be used to model another machine for systematic testing, using the
<em>substitution</em> feature of the P# language. To achieve this, the programmer has to use
the following special create statement:
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Foo</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token identifier psharp'>models</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Bar</span><span class='token delimiter psharp'>;</span></code></pre>
<p>In this case, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Foo</span></code> machine is used to model the Bar machine. During systematic testing,
the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Foo</span></code> machine will be created, whereas during real execution, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Bar</span></code> machine will be
created.
</p>
<p class="indent">Likewise, a method can model another method for systematic testing. The concept behind this
is similar to how a machine can model another machine. The following special call statement
can be used:
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token type identifier psharp'>Foo</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token keyword psharp'>for</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Bar</span><span class='token delimiter psharp'>;</span></code></pre>
<p>In this case, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Foo</span></code> method will be called instead of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Bar</span></code> method during systematic
testing, wheras the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Bar</span></code> method will be called during real execution.
</p><h3 id="sec-failure-detection-protocol"   style="font-weight:normal;bookmark:3.3.&#8194;Failure detection protocol"><span class="heading-before"><span class="heading-label">3.3</span>.&#8194;</span>Failure detection protocol</h3>
<p>The failure detection protocol is based on the interaction of two types of machines,
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Node</span></code>, which are shown below. The code of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code>
machine presents advanced features of P#, including <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code> transitions and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>pop</span></code>
statements, deferred events, and monitors.
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token comment psharp'>// FailureDetector.psharp</span><br><span class='token keyword psharp'>namespace</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// request from failure detector to node</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// response from node to failure detector</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// register a client for failure notification</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RegisterClient</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// unregister a client from failure notification</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>UnregisterClient</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token comment psharp'>// local events for control transfer within failure detector</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RoundDone</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>TimerCancelled</span><span class='token delimiter psharp'>;</span><br><br><span class='token white psharp'>  </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>List</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token identifier psharp'>nodes</span><span class='token delimiter psharp'>;</span><span class='token white psharp'>                 </span><span class='token comment psharp'>// nodes to be monitored</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token identifier psharp'>clients</span><span class='token delimiter psharp'>;</span><span class='token white psharp'>   </span><span class='token comment psharp'>// registered clients</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>int</span><span class='token white psharp'> </span><span class='token identifier psharp'>attempts</span><span class='token delimiter psharp'>;</span><span class='token white psharp'>                        </span><span class='token comment psharp'>// number of Ping attempts made</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>;</span><span class='token white psharp'>     </span><span class='token comment psharp'>// set of alive nodes</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token identifier psharp'>responses</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token comment psharp'>// collected responses in one round</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token identifier psharp'>timer</span><span class='token delimiter psharp'>;</span><br><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Init</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>nodes</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>List</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>clients</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>nodes</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>payload</span><span class='token white psharp'> </span><span class='token keyword psharp'>as</span><span class='token white psharp'> </span><span class='token type identifier psharp'>List</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token operator psharp'>&gt;</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>InitializealiveSet</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>timer</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timer</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RegisterClient</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>clients</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>true</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>UnregisterClient</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>clients</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>clients</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Remove</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>push</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPing</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>SendPings</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token comment psharp'>// send Ping events to machines that have not responded</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>timer</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Start</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token number psharp'>100</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token comment psharp'>// start timer for intra-round duration</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token comment psharp'>// collect Pong responses from alive machines</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>true</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Count</span><span class='token white psharp'> </span><span class='token operator psharp'>==</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Count</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>            </span><span class='token comment psharp'>// status of alive nodes has not changed</span><br><span class='token white psharp'>            </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>timer</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Cancel</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>            </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>TimerCancelled</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>          </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>TimerCancelled</span><span class='token white psharp'> </span><span class='token keyword psharp'>push</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForCancelResponse</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token comment psharp'>// one attempt is done</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>attempts</span>++<span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token comment psharp'>// maximum number of attempts per round == 2</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Count</span><span class='token white psharp'> </span><span class='token operator psharp'>&lt;</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Count</span><span class='token white psharp'> </span><span class='token operator psharp'>&amp;&amp;</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>attempts</span><span class='token white psharp'> </span><span class='token operator psharp'>&lt;</span><span class='token white psharp'> </span><span class='token number psharp'>2</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token comment psharp'>// try again by re-entering SendPing</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token white psharp'> </span><span class='token keyword psharp'>else</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>CheckaliveSet</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RoundDone</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Unit</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RoundDone</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Reset</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForCancelResponse</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>defer</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelSuccess</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>raise</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RoundDone</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CancelFailure</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>pop</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Reset</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token comment psharp'>// prepare for the next round</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>attempts</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token number psharp'>0</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Clear</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>timer</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Start</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token number psharp'>1000</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token comment psharp'>// start timer for inter-round duration</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token white psharp'> </span><span class='token keyword psharp'>goto</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>ignore</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>InitializealiveSet</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>foreach</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>var</span><span class='token white psharp'> </span><span class='token identifier psharp'>node</span><span class='token white psharp'> </span><span class='token keyword psharp'>in</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>nodes</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Add</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>true</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>SendPings</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>foreach</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>var</span><span class='token white psharp'> </span><span class='token identifier psharp'>node</span><span class='token white psharp'> </span><span class='token keyword psharp'>in</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>nodes</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token operator psharp'>&amp;&amp;</span><span class='token white psharp'> </span><span class='token operator psharp'>!</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>monitor</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Safety</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPing</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token identifier psharp'>node</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token identifier psharp'>node</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>CheckaliveSet</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>foreach</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>var</span><span class='token white psharp'> </span><span class='token identifier psharp'>node</span><span class='token white psharp'> </span><span class='token keyword psharp'>in</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>nodes</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token operator psharp'>&amp;&amp;</span><span class='token white psharp'> </span><span class='token operator psharp'>!</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>responses</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>alive</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Remove</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token delimiter curly psharp bracket-close'>}</span></code></pre>
<p>The state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> machine illustrates the use of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code>
transitions.
After appropriately initializing fields in the entry action, the raised event
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Unit</span></code> is handled by <em>pushing</em> state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code> on top of the current state
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code>. Thus, the use of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code> transitions creates a stack of states encoding
the control of a state-machine.
As long as state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> is on the stack, event handlers declared inside it are
available to be executed regardless of changes in any states above it.
The event handlers for <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>RegisterClient</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>UnregisterClient</span></code> are such available
handlers.
A <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code> transition from <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> to <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code> (rather than a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>goto</span></code> transition)
enables the declaration of these handlers in one place (the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> state) and
their reuse everywhere else in <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code>.
In addition to offering reuse of event handlers, push transitions also enable
reuse of protocol logic for handling specific interactions with other machines.
We later explain this use of a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code> transition in handling the interaction
between <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timer</span></code>.
</p>
<p class="indent">When the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code> of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> machine is entered, its entry
action sends <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code> events to all alive nodes that have not yet responded with
a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> event and starts a timer with a timeout value of 100ms.
The machine stays in this state collecting <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> responses until either all alive
nodes have responded or a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code> event is dequeued.
If each alive node has responded with a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> before <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code> is dequeued, the
timer is canceled and the event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>TimerCancelled</span></code> is raised. Otherwise, the handler
of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code> is executed to determine whether another attempt to reach the
potentially alive nodes should be made. If the number of attempts has reached the
maximum number of attempts (2 in this example), then the nodes have failed.
</p>
<p class="indent">The state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code> of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> illustrates the use of a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code> transition
to factor out the logic for handling timer cancelation.
When <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>TimerCancelled</span></code> is raised after canceling the timer because all alive nodes
have responded with <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code>, the handler <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>TimerCancelled</span><span class='token white psharp'> </span><span class='token keyword psharp'>push</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitForCancelResponse</span></code>
pushes the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code> on top of the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code>.
The state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code> handles the interaction with the timer subsequent
to its cancelation, returning control back to <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code> afterwards. The timer may
respond with either <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelSuccess</span></code> or <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>CancelFailure</span></code>.
In the former case, the event <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>RoundDone</span></code> is raised which is not handled in state
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>TimerCancelled</span></code> causing the state to be popped and letting the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code>
handle the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>RoundDone</span></code> event.
In the latter case, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>pop</span></code> statement executes causing <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>TimerCancelled</span></code> to be
popped and a fresh event being dequeued in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code>.
</p>
<p class="indent">The state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code> uses the code <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>defer</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Timeout</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span></code> to indicate
that it is not willing to handle <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> states in this state.
Therefore, while the machine is blocked in this state, the P# runtime does not
dequeue these two events, instead <em>skips</em> them to retrieve any other event in the
input queue.
</p>
<p class="indent">When the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> machine is blocked in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code>,
its stack has three states on it.
Starting from the bottom of the stack, these states are <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code>, <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code>, and
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code>.
The <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Init</span></code> state specifies <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>do</span></code> handlers for <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>RegisterClient</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>UnregisterClient</span></code>,
the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>SendPing</span></code> state specifies <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>do</span></code> handlers for <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code>,
and the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code> state defers <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code>.
The dequeue logic for P# allows the execution of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>do</span></code> handlers specified anywhere
in the stack <em>unless</em> deferred in a state above.
Therefore, in the state <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>WaitForCancelResponse</span></code>, the events <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>RegisterClient</span></code> and
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>UnregisterClient</span></code> may be dequeued, but the events <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timeout</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> may not.
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token comment psharp'>// Node.psharp</span><br><span class='token keyword psharp'>namespace</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Node</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>WaitPing</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Ping</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>monitor</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Safety</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPong</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pong</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token delimiter curly psharp bracket-close'>}</span><br><br><span class='token comment psharp'>// Safety.psharp</span><br><span class='token keyword psharp'>namespace</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPing</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>event</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPong</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>  </span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>monitor</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Safety</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>int</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Pending</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Init</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>int</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPing</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>if</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token operator psharp'>!</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>          </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token number psharp'>0</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>        </span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>+</span><span class='token white psharp'> </span><span class='token number psharp'>1</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>assert</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>&lt;=</span><span class='token white psharp'> </span><span class='token number psharp'>3</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>on</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPong</span><span class='token white psharp'> </span><span class='token keyword psharp'>do</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>assert</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ContainsKey</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>assert</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token number psharp'>0</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Pending</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>machine</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token keyword psharp'>payload</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token operator psharp'>-</span><span class='token white psharp'> </span><span class='token number psharp'>1</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token delimiter curly psharp bracket-close'>}</span></code></pre>
<p>P# also allows programmers to write <em>assertions</em> that express invariants on the local
state of a machine. This can be achieved using the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span></code> statement.
However, it is often useful to be able to write assertions about state across
machines in a program. P# provides <em>monitors</em> that enable writting such specifications.
Consider the problem of specifying that the difference in the number of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code>
events sent to any machine can never be three more than the number of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> events
sent by it.
This specification can be encoded using the monitor machine <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Safety</span></code>. This monitor
maintains the difference between the number of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Ping</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Pong</span></code> events per machine
in a C# dictionary and asserts that this number can be at most three.
The failure detection protocol communicates with this monitor by sending it <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>MPing</span></code>
and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>MPong</span></code> events using a statement such as <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>monitor</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Safety</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>MPong</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span></code>.
</p><h3 id="sec-test-driver-machine"   style="font-weight:normal;bookmark:3.4.&#8194;Test driver machine"><span class="heading-before"><span class="heading-label">3.4</span>.&#8194;</span>Test driver machine</h3>
<p>The machine <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Driver</span></code> shows how to write a test driver to test the failure detection
protocol. This machine models a client of the protocol. This client creates a few
nodes to be monitored, creates an instance of the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Safety</span></code> monitor, an instance of
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code>, registers itself with the created instance of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code>,
and then enqueues the special <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code> event to each node created by it to terminate
that node. Thus, the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Driver</span></code> machine creates a finite test program for the failure
detection protocol.
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token comment psharp'>// Driver.psharp</span><br><span class='token keyword psharp'>namespace</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>model</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Driver</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>machine</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>List</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token type identifier psharp'>NodeSeq</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token white psharp'> </span><span class='token type identifier psharp'>NodeMap</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>start</span><span class='token white psharp'> </span><span class='token keyword psharp'>state</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Init</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>entry</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>NodeSeq</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>List</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>NodeMap</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>new</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Dictionary</span><span class='token operator psharp'>&lt;</span><span class='token keyword psharp'>machine</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>bool</span><span class='token operator psharp'>&gt;</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Initialize</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Safety</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>FailureDetector</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>NodeSeq</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>FailureDetector</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token type identifier psharp'>RegisterClient</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Fail</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Initialize</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>for</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>int</span><span class='token white psharp'> </span><span class='token identifier psharp'>i</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token number psharp'>0</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token identifier psharp'>i</span><span class='token white psharp'> </span><span class='token operator psharp'>&lt;</span><span class='token white psharp'> </span><span class='token number psharp'>2</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token identifier psharp'>i</span>++<span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>var</span><span class='token white psharp'> </span><span class='token identifier psharp'>node</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token keyword psharp'>create</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Node</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>NodeSeq</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Add</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>NodeMap</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>Add</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token identifier psharp'>node</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>true</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Fail</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token keyword psharp'>for</span><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>int</span><span class='token white psharp'> </span><span class='token identifier psharp'>i</span><span class='token white psharp'> </span><span class='token operator psharp'>=</span><span class='token white psharp'> </span><span class='token number psharp'>0</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token identifier psharp'>i</span><span class='token white psharp'> </span><span class='token operator psharp'>&lt;</span><span class='token white psharp'> </span><span class='token number psharp'>2</span><span class='token delimiter psharp'>;</span><span class='token white psharp'> </span><span class='token identifier psharp'>i</span>++<span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>        </span><span class='token keyword psharp'>send</span><span class='token white psharp'> </span><span class='token keyword psharp'>this</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>NodeSeq</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token identifier psharp'>i</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token delimiter psharp'>,</span><span class='token white psharp'> </span><span class='token keyword psharp'>halt</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><br><span class='token white psharp'>  </span><span class='token keyword psharp'>public</span><span class='token white psharp'> </span><span class='token keyword psharp'>class</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Test</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>    </span><span class='token keyword psharp'>static</span><span class='token white psharp'> </span><span class='token keyword psharp'>void</span><span class='token white psharp'> </span><span class='token type identifier psharp'>Main</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>string</span><span class='token delimiter square psharp bracket-open'>[</span><span class='token delimiter square psharp bracket-close'>]</span><span class='token white psharp'> </span><span class='token identifier psharp'>args</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token white psharp'> </span><span class='token delimiter curly psharp bracket-open'>{</span><br><span class='token white psharp'>      </span><span class='token type identifier psharp'>PSharpRuntime</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>CreateMachine</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token keyword psharp'>typeof</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token type identifier psharp'>Driver</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>      </span><span class='token type identifier psharp'>Console</span><span class='token delimiter psharp'>.</span><span class='token type identifier psharp'>ReadLine</span><span class='token delimiter parenthesis psharp bracket-open'>(</span><span class='token delimiter parenthesis psharp bracket-close'>)</span><span class='token delimiter psharp'>;</span><br><span class='token white psharp'>    </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token white psharp'>  </span><span class='token delimiter curly psharp bracket-close'>}</span><br><span class='token delimiter curly psharp bracket-close'>}</span></code></pre>
<p>Even though the test program encoded by machine <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Driver</span></code> is finite, it can generate
an enormous number of behaviors resulting primarily from the concurrent execution
of a number of state machines: one <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Driver</span></code> machine, two <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Node</span></code> machines, one
<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>FailureDetector</span></code> machine, and one <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Timer</span></code> machine.
At each step in an execution when a non-local action (creation of a machine or
sending an event from one machine to another) is about to execute, there is a choice
of picking <em>any</em> one of these machines to execute. 
The testing infrastructure embedded in the P# compiler <em>systematically enumerates</em>
these behaviors; if an exception is raised or an assertion is violated, a path to
the error is reported to the programmer. 
</p>
<p class="indent">The style of specifying test programs in the manner described above results in a
compact description of a large set of test executions, considerably reducing the
programmer&#39;s effort in specifying and generating them.
For example, even though the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Driver</span></code> machine sends a <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code> event to each <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>Node</span></code>
machine immediately after creating them, these send actions may be arbitrarily
<em>delayed</em> if a nondeterministic scheduler chooses to execute the other machines 
in the program instead. The P# systematic tester has the capability to enumerate
such behaviors to explore <em>tricky</em> interleavings between event handlers.
</p><h2 id="sec-tools"   style="font-weight:normal;bookmark:4.&#8194;Tools"><span class="heading-before"><span class="heading-label">4</span>.&#8194;</span>Tools</h2>
<p><img src="images/workflow.png" title="workflow" alt="workflow" data-path="images/workflow.png" data-linkid="workflow" style="width:auto;max-width:60%">
</p>
<p class="indent">The above figure shows a typical P# workflow. The programmer initially creates a P#
application and then uses the compiler to parse, compile and systematically test this
application. This process repeats until all bugs are discovered and fixed.
</p><h3 id="sec-compilation"   style="font-weight:normal;bookmark:4.1.&#8194;Compilation"><span class="heading-before"><span class="heading-label">4.1</span>.&#8194;</span>Compilation</h3>
<p>The compiler executable is called <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>PSharpCompiler</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>exe</span></code>. It accepts a P# solution, which
can contain a number of <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>psharp</span></code> and <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>cs</span></code> files, and various optional arguments as
input. The options can be discovered by running <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>PSharpCompiler</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>exe</span><span class='token white psharp'> </span><span class='token operator psharp'>/</span><span class='token source psharp'>?</span></code> from the command
line.
</p>
<p class="indent">The compiler is based on a three-phase compilation approach: it initially parses the
P# surface syntax and reports any P#-related syntax errors; it then rewrites the
original P# program into an intermediate C# representation; it finally uses the Roslyn
compiler to parse and compile the intermediate C# program to an executable file (<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>exe</span></code>)
or library (<code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>dll</span></code>), and link it with the P# libraries and C# system libraries. Any
C#-specific compile errors will be reported in this final Roslyn-based compilation phase.
</p>
<p class="indent">The P# compiler can be invoked on a P# solution with the following command:
</p>
<pre class="para-block pre-fenced pre-fenced3 language-text/psharp lang-text/psharp text/psharp highlighted" ><code><span class='token delimiter psharp'>.</span><span class='token source psharp'>\</span><span class='token type identifier psharp'>PSharpCompiler</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>exe</span><span class='token white psharp'> </span><span class='token operator psharp'>/</span><span class='token identifier psharp'>s</span>:$<span class='token delimiter curly psharp bracket-open'>{</span><span class='token type identifier psharp'>SOLUTION_PATH</span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token source psharp'>\</span><span class='token identifier psharp'>$</span><span class='token delimiter curly psharp bracket-open'>{</span><span class='token type identifier psharp'>SOLUTION_NAME</span><span class='token delimiter curly psharp bracket-close'>}</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>sln</span></code></pre>
<p>To build only a single specific project from a given solution use the <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token operator psharp'>/</span><span class='token identifier psharp'>p</span>:$<span class='token delimiter curly psharp bracket-open'>{</span><span class='token type identifier psharp'>PROJECT_NAME</span><span class='token delimiter curly psharp bracket-close'>}</span></code> command
line option.
</p><h3 id="sec-execution"   style="font-weight:normal;bookmark:4.2.&#8194;Execution"><span class="heading-before"><span class="heading-label">4.2</span>.&#8194;</span>Execution</h3>
<p>To execute the compiled program, run the executable that is produced by <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token type identifier psharp'>PSharpCompiler</span><span class='token delimiter psharp'>.</span><span class='token identifier psharp'>exe</span></code>
(found in the directory specified by the P# project). If the compiled program is a library,
then link the library as in any typical .NET project.
A typical P# application consists of one or more P# machines communicating asynchronously
with each other by sending and receiving events. The P# runtime is responsible for handling
all the underlying asynchrony when a machine creates a new machine or sends an event to a
target machine.
</p><h3 id="sec-systematic-testing"   style="font-weight:normal;bookmark:4.3.&#8194;Systematic Testing"><span class="heading-before"><span class="heading-label">4.3</span>.&#8194;</span>Systematic Testing</h3>
<p>Once the programmer fixes all the statically discovered errors, the compiler can be used
to systematically test the P# application. This is achieved by running the compiler in
<em>bug-finding</em> mode. In this mode, the systematic tester takes control of the underlying
schedule and systematically explores event handling interleavings to discover bugs in the
P# program.
</p>
<p class="indent">To switch to bug-finding mode the command-line option <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token operator psharp'>/</span><span class='token identifier psharp'>test</span></code> must be given when invoking
the P# compiler.
</p>
<p class="indent">By default, the systematic tester will explore a single iteration using an exploration
depth bound of 1000. This depth bound is the maximum number of scheduling steps that
the systematic tester will take while exploring a single schedule of the program. To
increase the depth bound use the command line option <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token operator psharp'>/</span><span class='token identifier psharp'>db</span><span class='token operator psharp'>:</span><span class='token identifier psharp'>x</span></code> where <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>x</span></code> is a positive
integer. To increase the number of schedules to be explored (from program start to a
terminal state) use the command line option <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token operator psharp'>/</span><span class='token identifier psharp'>i</span><span class='token operator psharp'>:</span><span class='token identifier psharp'>x</span></code> where <code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>x</span></code> is a positive integer.
</p>
<p class="indent">If a dynamic error is discovered, the systematic testing will terminate, and a complete
error trace starting from the initial state of the program is dumped on the disk in a
text file (in the same directory as the compiled binaries of the P# application). The
programmer can fix the found bug and run the compiler and systematic testing again on
the modified program. Search statistics are also printed during and at the end of the
systematic testing.
</p><h2 id="sec-glossary"   style="font-weight:normal;bookmark:5.&#8194;Glossary"><span class="heading-before"><span class="heading-label">5</span>.&#8194;</span>Glossary</h2>
<div class="grammar"><table class="grammar-table madoko block" data-line="1" style="th-background-color:gainsboro">
<thead><tr><th class="thead tr-even col cell-border-left cell-line col-odd col-first" data-line="1" data-row="0" data-col="1" style="text-align:left;background-color:gainsboro"></th><th class="thead tr-even col cell-border-right cell-line col-even col-last" data-line="1" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"></th></tr>
<tr><th class="thead tr-odd tr-first col cell-border-left cell-border-right col-odd col-last col-first" data-line="2" data-row="1" colspan="2" data-col="1" style="text-align:center;background-color:gainsboro"><span data-line="2"></span> Types                                                                                               </th></tr>
<tr><th class="thead tr-even tr-last col cell-border-left col-odd col-first" data-line="3" data-row="2" data-col="1" style="text-align:left;background-color:gainsboro"><span data-line="3"></span> Syntax    </th><th class="thead tr-even tr-last col cell-border-right col-even col-last" data-line="3" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"><span data-line="3"></span> Description                                                                              </th></tr></thead>
<tbody><tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-row="0" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr>
<tr><td class="tbody tr-odd tr-first col cell-border-left col-odd col-first" data-line="5" data-row="1" data-col="1" style="text-align:left"><span data-line="5"></span> <span data-line="5"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code><span data-line="5"></span> </td><td class="tbody tr-odd tr-first col cell-border-right col-even col-last" data-line="5" data-row="1" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="5"></span> A reference to a P<span data-line="5"></span>#<span data-line="5"></span> machine.                                                             </td></tr>
<tr><td class="tbody tr-even tr-last col cell-border-left col-odd col-first" data-line="6" data-row="2" data-col="1" style="text-align:left"><span data-line="6"></span> type      </td><td class="tbody tr-even tr-last col cell-border-right col-even col-last" data-line="6" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="6"></span> The set of all possible C<span data-line="6"></span>#<span data-line="6"></span> types (either primitive, such as <span data-line="6"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>int</span></code><span data-line="6"></span> and <span data-line="6"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>bool</span></code><span data-line="6"></span>, or custom).</td></tr>
<tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-line="7" data-row="2" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-line="7" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr></tbody></table><table class="grammar-table madoko block" data-line="10" style="th-background-color:gainsboro">
<thead><tr><th class="thead tr-even col cell-border-left cell-line col-odd col-first" data-line="10" data-row="0" data-col="1" style="text-align:left;background-color:gainsboro"></th><th class="thead tr-even col cell-border-right cell-line col-even col-last" data-line="10" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"></th></tr>
<tr><th class="thead tr-odd tr-first col cell-border-left cell-border-right col-odd col-last col-first" data-line="11" data-row="1" colspan="2" data-col="1" style="text-align:center;background-color:gainsboro"><span data-line="11"></span> Machines and Events                                                                                                                                                                                                                                </th></tr>
<tr><th class="thead tr-even tr-last col cell-border-left col-odd col-first" data-line="12" data-row="2" data-col="1" style="text-align:left;background-color:gainsboro"><span data-line="12"></span> Syntax                                               </th><th class="thead tr-even tr-last col cell-border-right col-even col-last" data-line="12" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"><span data-line="12"></span> Description                                                                                                                                                                                  </th></tr></thead>
<tbody><tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-row="0" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr>
<tr><td class="tbody tr-odd tr-first col cell-border-left col-odd col-first" data-line="14" data-row="1" data-col="1" style="text-align:left"><span data-line="14"></span> <span data-line="14"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>default</span></code><span data-line="14"></span>                                            </td><td class="tbody tr-odd tr-first col cell-border-right col-even col-last" data-line="14" data-row="1" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="14"></span> A pseudo-event that may be taken when no other event is triggered. Taking a <span data-line="14"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>default</span></code><span data-line="14"></span> event sets <span data-line="14"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>trigger</span></code><span data-line="14"></span> and <span data-line="14"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>payload</span></code><span data-line="14"></span> to null.                                                            </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="15" data-row="2" data-col="1" style="text-align:left"><span data-line="15"></span> <span data-line="15"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code><span data-line="15"></span>                                               </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="15" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="15"></span> A predefined event that causes a machine to shutdown. The user implements a machine<span data-line="15"></span>&#39;<span data-line="15"></span>s response to <span data-line="15"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code><span data-line="15"></span>. A machine is shutdown when its state stack becomes empty with <span data-line="15"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>trigger</span></code><span data-line="15"></span> == <span data-line="15"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code><span data-line="15"></span>. </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="16" data-row="3" data-col="1" style="text-align:left"><span data-line="16"></span> <span data-line="16"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>event</span></code><span data-line="16"></span> e <span data-line="16"></span>[<span data-line="16"></span> {<span data-line="16"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span></code><span data-line="16"></span> <span data-line="16"></span>|<span data-line="16"></span> <span data-line="16"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>assume</span></code><span data-line="16"></span>} k];              </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="16" data-row="3" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="16"></span> Declares an event.<span data-line="16"></span><sup>a</sup><span data-line="16"></span>                                                                                                                                                                        </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="17" data-row="4" data-col="1" style="text-align:left"><span data-line="17"></span> <span data-line="17"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>machine</span></code><span data-line="17"></span> M <span data-line="17"></span>[<span data-line="17"></span> {<span data-line="17"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span></code><span data-line="17"></span> <span data-line="17"></span>|<span data-line="17"></span> <span data-line="17"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>assume</span></code><span data-line="17"></span>} k] <span data-line="17"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="17"></span> <span data-line="17"></span>&#8230;<span data-line="17"></span> <span data-line="17"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="17"></span> </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="17" data-row="4" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="17"></span> Declares a machine.<span data-line="17"></span><sup>b</sup><span data-line="17"></span>                                                                                                                                                                       </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="18" data-row="5" data-col="1" style="text-align:left"><span data-line="18"></span> <span data-line="18"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>model</span></code><span data-line="18"></span> M <span data-line="18"></span>[<span data-line="18"></span> {<span data-line="18"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span></code><span data-line="18"></span> <span data-line="18"></span>|<span data-line="18"></span> <span data-line="18"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>assume</span></code><span data-line="18"></span>} k] <span data-line="18"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="18"></span> <span data-line="18"></span>&#8230;<span data-line="18"></span> <span data-line="18"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="18"></span>   </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="18" data-row="5" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="18"></span> Declares a model machine.<span data-line="18"></span><sup>b</sup><span data-line="18"></span>                                                                                                                                                                 </td></tr>
<tr><td class="tbody tr-even tr-last col cell-border-left col-odd col-first" data-line="19" data-row="6" data-col="1" style="text-align:left"><span data-line="19"></span> <span data-line="19"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>monitor</span></code><span data-line="19"></span> M <span data-line="19"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="19"></span> <span data-line="19"></span>&#8230;<span data-line="19"></span> <span data-line="19"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="19"></span>                              </td><td class="tbody tr-even tr-last col cell-border-right col-even col-last" data-line="19" data-row="6" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="19"></span> Declares a property monitor.                                                                                                                                                                 </td></tr>
<tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-line="20" data-row="6" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-line="20" data-row="6" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr></tbody></table>
<p data-line="23"><span data-line="23"></span><sup>a</sup><span data-line="23"></span> An event e may optionally be annotated with <span data-line="23"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span><span class='token white psharp'> </span><span class='token identifier psharp'>k</span></code><span data-line="23"></span> or <span data-line="23"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>assume</span><span class='token white psharp'> </span><span class='token identifier psharp'>k</span></code><span data-line="23"></span>.
The former specifies that there must not be more than k instances of e in the input
queue of any machine. The latter specifies that during systematic testing, an
execution that increases the cardinality of e beyond k in some queue must not be
generated. Both compile to an assertion in code generated for execution.
</p>
<p class="indent" data-line="29"><span data-line="29"></span><sup>b</sup><span data-line="29"></span> A machine or model M may optionally be annotated with <span data-line="29"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span><span class='token white psharp'> </span><span class='token identifier psharp'>k</span></code><span data-line="29"></span> or <span data-line="29"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token identifier psharp'>assume</span><span class='token white psharp'> </span><span class='token identifier psharp'>k</span></code><span data-line="29"></span>.
Their meaning is similar to that of the corresponding annotation for an event except
that the bound k refers to the total number of events in the input queue of M.
</p><table class="grammar-table madoko block" data-line="34" style="th-background-color:gainsboro">
<thead><tr><th class="thead tr-even col cell-border-left cell-line col-odd col-first" data-line="34" data-row="0" data-col="1" style="text-align:left;background-color:gainsboro"></th><th class="thead tr-even col cell-border-right cell-line col-even col-last" data-line="34" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"></th></tr>
<tr><th class="thead tr-odd tr-first col cell-border-left cell-border-right col-odd col-last col-first" data-line="35" data-row="1" colspan="2" data-col="1" style="text-align:center;background-color:gainsboro"><span data-line="35"></span>States, State Variables, and Functions (declared inside machines)                                                                                           </th></tr>
<tr><th class="thead tr-even tr-last col cell-border-left col-odd col-first" data-line="36" data-row="2" data-col="1" style="text-align:left;background-color:gainsboro"><span data-line="36"></span> Syntax                           </th><th class="thead tr-even tr-last col cell-border-right col-even col-last" data-line="36" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"><span data-line="36"></span> Description                                                                                                              </th></tr></thead>
<tbody><tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-row="0" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr>
<tr><td class="tbody tr-odd tr-first col cell-border-left col-odd col-first" data-line="38" data-row="1" data-col="1" style="text-align:left"><span data-line="38"></span> <span data-line="38"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>this</span></code><span data-line="38"></span>                           </td><td class="tbody tr-odd tr-first col cell-border-right col-even col-last" data-line="38" data-row="1" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="38"></span> Refers to the current instance of a machine.                                                                             </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="39" data-row="2" data-col="1" style="text-align:left"><span data-line="39"></span> <span data-line="39"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>trigger</span></code><span data-line="39"></span>                        </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="39" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="39"></span> Refers to the event causing the current entry or exit of a state; it is initially <span data-line="39"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>null</span></code><span data-line="39"></span>.                                </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="40" data-row="3" data-col="1" style="text-align:left"><span data-line="40"></span> <span data-line="40"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>payload</span></code><span data-line="40"></span>                        </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="40" data-row="3" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="40"></span> Refers to the payload of the event causing entry or exit of a state; initially the value passed to the <span data-line="40"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>create</span></code><span data-line="40"></span> operator.</td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="41" data-row="4" data-col="1" style="text-align:left"><span data-line="41"></span> <span data-line="41"></span>[<span data-line="41"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>start</span></code><span data-line="41"></span>] <span data-line="41"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>state</span></code><span data-line="41"></span> S <span data-line="41"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="41"></span> <span data-line="41"></span>&#8230;<span data-line="41"></span> <span data-line="41"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="41"></span> </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="41" data-row="4" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="41"></span> Declares a (starting) state S.                                                                                           </td></tr>
<tr><td class="tbody tr-odd tr-last col cell-border-left col-odd col-first" data-line="42" data-row="5" data-col="1" style="text-align:left"><span data-line="42"></span> <span data-line="42"></span>[<span data-line="42"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>model</span></code><span data-line="42"></span>] method declaration    </td><td class="tbody tr-odd tr-last col cell-border-right col-even col-last" data-line="42" data-row="5" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="42"></span> Declares a (model) C<span data-line="42"></span>#<span data-line="42"></span> method with zero or more formal parameters.                                                        </td></tr>
<tr><td class="tbody tr-odd col cell-border-left cell-line col-odd col-first" data-line="43" data-row="5" data-col="1" style="text-align:left"></td><td class="tbody tr-odd col cell-border-right cell-line col-even col-last" data-line="43" data-row="5" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr></tbody></table><table class="grammar-table madoko block" data-line="46" style="th-background-color:gainsboro">
<thead><tr><th class="thead tr-even col cell-border-left cell-line col-odd col-first" data-line="46" data-row="0" data-col="1" style="text-align:left;background-color:gainsboro"></th><th class="thead tr-even col cell-border-right cell-line col-even col-last" data-line="46" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"></th></tr>
<tr><th class="thead tr-odd tr-first col cell-border-left cell-border-right col-odd col-last col-first" data-line="47" data-row="1" colspan="2" data-col="1" style="text-align:center;background-color:gainsboro"><span data-line="47"></span>State Actions and Transitions (declared inside states)                                                                                                                                                                           </th></tr>
<tr><th class="thead tr-even tr-last col cell-border-left col-odd col-first" data-line="48" data-row="2" data-col="1" style="text-align:left;background-color:gainsboro"><span data-line="48"></span>Syntax                                           </th><th class="thead tr-even tr-last col cell-border-right col-even col-last" data-line="48" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"><span data-line="48"></span> Description                                                                                                                                                                    </th></tr></thead>
<tbody><tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-row="0" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr>
<tr><td class="tbody tr-odd tr-first col cell-border-left col-odd col-first" data-line="50" data-row="1" data-col="1" style="text-align:left"><span data-line="50"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code><span data-line="50"></span> A<span data-line="50"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="50"></span>                                     </td><td class="tbody tr-odd tr-first col cell-border-right col-even col-last" data-line="50" data-row="1" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="50"></span> An action A to be executed whenever this state is entered.                                                                                                                     </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="51" data-row="2" data-col="1" style="text-align:left"><span data-line="51"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>entry</span></code><span data-line="51"></span> <span data-line="51"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="51"></span> <span data-line="51"></span>&#8230;<span data-line="51"></span> <span data-line="51"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="51"></span>                              </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="51" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="51"></span> A code block to be executed whenever this state is entered.                                                                                                                    </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="52" data-row="3" data-col="1" style="text-align:left"><span data-line="52"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>exit</span></code><span data-line="52"></span> A<span data-line="52"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="52"></span>                                      </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="52" data-row="3" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="52"></span> An action A to be executed whenever this state exits.                                                                                                                          </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="53" data-row="4" data-col="1" style="text-align:left"><span data-line="53"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>exit</span></code><span data-line="53"></span> <span data-line="53"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="53"></span> <span data-line="53"></span>&#8230;<span data-line="53"></span> <span data-line="53"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="53"></span>                               </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="53" data-row="4" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="53"></span> A code block to be executed whenever this state exits.                                                                                                                         </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="54" data-row="5" data-col="1" style="text-align:left"><span data-line="54"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>defer</span></code><span data-line="54"></span> e<span data-line="54"></span><sub>1</sub><span data-line="54"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="54"></span> <span data-line="54"></span>&#8230;<span data-line="54"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="54"></span> e<span data-line="54"></span><sub>n</sub><span data-line="54"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="54"></span>                       </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="54" data-row="5" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="54"></span> A list of events to skip while examining the queue for an event to handle.                                                                                                     </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="55" data-row="6" data-col="1" style="text-align:left"><span data-line="55"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>ignore</span></code><span data-line="55"></span> e<span data-line="55"></span><sub>1</sub><span data-line="55"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="55"></span> <span data-line="55"></span>&#8230;<span data-line="55"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="55"></span> e<span data-line="55"></span><sub>n</sub><span data-line="55"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="55"></span>                      </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="55" data-row="6" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="55"></span> A list of events to immediately remove while examining the queue for an event to handle.                                                                                       </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="56" data-row="7" data-col="1" style="text-align:left"><span data-line="56"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span></code><span data-line="56"></span> e<span data-line="56"></span><sub>1</sub><span data-line="56"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="56"></span> <span data-line="56"></span>&#8230;<span data-line="56"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="56"></span> e<span data-line="56"></span><sub>n</sub><span data-line="56"></span> <span data-line="56"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>do</span></code><span data-line="56"></span> A<span data-line="56"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="56"></span>                   </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="56" data-row="7" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="56"></span> A list of events to immediately remove while examining the queue for an event to handle. Each removal causes execution of A.                                                   </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="57" data-row="8" data-col="1" style="text-align:left"><span data-line="57"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span></code><span data-line="57"></span> e<span data-line="57"></span><sub>1</sub><span data-line="57"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="57"></span> <span data-line="57"></span>&#8230;<span data-line="57"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="57"></span> e<span data-line="57"></span><sub>n</sub><span data-line="57"></span> <span data-line="57"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>do</span></code><span data-line="57"></span> <span data-line="57"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="57"></span> <span data-line="57"></span>&#8230;<span data-line="57"></span> <span data-line="57"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="57"></span>            </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="57" data-row="8" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="57"></span> A list of events to immediately remove while examining the queue for an event to handle. Each removal causes execution of code block.                                          </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="58" data-row="9" data-col="1" style="text-align:left"><span data-line="58"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span></code><span data-line="58"></span> e<span data-line="58"></span><sub>1</sub><span data-line="58"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="58"></span> <span data-line="58"></span>&#8230;<span data-line="58"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="58"></span> e<span data-line="58"></span><sub>n</sub><span data-line="58"></span> <span data-line="58"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>goto</span></code><span data-line="58"></span> S <span data-line="58"></span>[<span data-line="58"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>with</span></code><span data-line="58"></span> A]<span data-line="58"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="58"></span>     </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="58" data-row="9" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="58"></span> A handler triggered whenever some e<span data-line="58"></span><sub>i</sub><span data-line="58"></span> is encountered in the queue. Causes removal of e<span data-line="58"></span><sub>i</sub><span data-line="58"></span> from queue, execution of exit function, (execution of A), and entry into state S.       </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="59" data-row="10" data-col="1" style="text-align:left"><span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span></code><span data-line="59"></span> e<span data-line="59"></span><sub>1</sub><span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="59"></span> <span data-line="59"></span>&#8230;<span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="59"></span> e<span data-line="59"></span><sub>n</sub><span data-line="59"></span> <span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>goto</span></code><span data-line="59"></span> S <span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>with</span></code><span data-line="59"></span> <span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-open'>{</span></code><span data-line="59"></span> <span data-line="59"></span>&#8230;<span data-line="59"></span> <span data-line="59"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter curly psharp bracket-close'>}</span></code><span data-line="59"></span> </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="59" data-row="10" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="59"></span> A handler triggered whenever some e<span data-line="59"></span><sub>i</sub><span data-line="59"></span> is encountered in the queue. Causes removal of e<span data-line="59"></span><sub>i</sub><span data-line="59"></span> from queue, execution of exit function, execution of code block, and entry into state S.</td></tr>
<tr><td class="tbody tr-odd tr-last col cell-border-left col-odd col-first" data-line="60" data-row="11" data-col="1" style="text-align:left"><span data-line="60"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>on</span></code><span data-line="60"></span> e<span data-line="60"></span><sub>1</sub><span data-line="60"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="60"></span> <span data-line="60"></span>&#8230;<span data-line="60"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="60"></span> e<span data-line="60"></span><sub>n</sub><span data-line="60"></span> <span data-line="60"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>push</span></code><span data-line="60"></span> S<span data-line="60"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="60"></span>                 </td><td class="tbody tr-odd tr-last col cell-border-right col-even col-last" data-line="60" data-row="11" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="60"></span> A handler triggered whenever some e<span data-line="60"></span><sub>i</sub><span data-line="60"></span> is encountered in the queue. Causes removal of e<span data-line="60"></span><sub>i</sub><span data-line="60"></span> from queue, pushing of current state onto state stack, and entry into state S.          </td></tr>
<tr><td class="tbody tr-odd col cell-border-left cell-line col-odd col-first" data-line="61" data-row="11" data-col="1" style="text-align:left"></td><td class="tbody tr-odd col cell-border-right cell-line col-even col-last" data-line="61" data-row="11" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr></tbody></table><table class="grammar-table madoko block" data-line="64" style="th-background-color:gainsboro">
<thead><tr><th class="thead tr-even col cell-border-left cell-line col-odd col-first" data-line="64" data-row="0" data-col="1" style="text-align:left;background-color:gainsboro"></th><th class="thead tr-even col cell-border-right cell-line col-even col-last" data-line="64" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"></th></tr>
<tr><th class="thead tr-odd tr-first col cell-border-left cell-border-right col-odd col-last col-first" data-line="65" data-row="1" colspan="2" data-col="1" style="text-align:center;background-color:gainsboro"><span data-line="65"></span>P<span data-line="65"></span>#<span data-line="65"></span> Statements                                                                                                                                                                              </th></tr>
<tr><th class="thead tr-even tr-last col cell-border-left col-odd col-first" data-line="66" data-row="2" data-col="1" style="text-align:left;background-color:gainsboro"><span data-line="66"></span>Syntax                                    </th><th class="thead tr-even tr-last col cell-border-right col-even col-last" data-line="66" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left;background-color:gainsboro"><span data-line="66"></span> Description                                                                                                                                     </th></tr></thead>
<tbody><tr><td class="tbody tr-even col cell-border-left cell-line col-odd col-first" data-row="0" data-col="1" style="text-align:left"></td><td class="tbody tr-even col cell-border-right cell-line col-even col-last" data-row="0" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr>
<tr><td class="tbody tr-odd tr-first col cell-border-left col-odd col-first" data-line="68" data-row="1" data-col="1" style="text-align:left"><span data-line="68"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>create</span></code><span data-line="68"></span> M<span data-line="68"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token white psharp'> </span><span class='token delimiter parenthesis psharp bracket-open'>(</span></code><span data-line="68"></span>v<span data-line="68"></span><sub>1</sub><span data-line="68"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="68"></span> <span data-line="68"></span>&#8230;<span data-line="68"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="68"></span> v<span data-line="68"></span><sub>n</sub><span data-line="68"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter parenthesis psharp bracket-close'>)</span></code><span data-line="68"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="68"></span>       </td><td class="tbody tr-odd tr-first col cell-border-right col-even col-last" data-line="68" data-row="1" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="68"></span> Creates a new instance of a machine or monitor with type M, and with payload set to (v<span data-line="68"></span><sub>1</sub><span data-line="68"></span>, <span data-line="68"></span>&#8230;<span data-line="68"></span>, v<span data-line="68"></span><sub>n</sub><span data-line="68"></span>).                                              </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="69" data-row="2" data-col="1" style="text-align:left"><span data-line="69"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>raise</span></code><span data-line="69"></span> ev <span data-line="69"></span>[<span data-line="69"></span>(v<span data-line="69"></span><sub>1</sub><span data-line="69"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="69"></span> <span data-line="69"></span>&#8230;<span data-line="69"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="69"></span> v<span data-line="69"></span><sub>n</sub><span data-line="69"></span>) ]<span data-line="69"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="69"></span>       </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="69" data-row="2" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="69"></span> Causes immediate handling of event expression ev (and sets payload to (v<span data-line="69"></span><sub>1</sub><span data-line="69"></span>, <span data-line="69"></span>&#8230;<span data-line="69"></span>, v<span data-line="69"></span><sub>n</sub><span data-line="69"></span>)).                                                           </td></tr>
<tr><td class="tbody tr-odd col cell-border-left col-odd col-first" data-line="70" data-row="3" data-col="1" style="text-align:left"><span data-line="70"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>send</span></code><span data-line="70"></span> dst<span data-line="70"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="70"></span> ev <span data-line="70"></span>[<span data-line="70"></span>(v<span data-line="70"></span><sub>1</sub><span data-line="70"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="70"></span> <span data-line="70"></span>&#8230;<span data-line="70"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>,</span></code><span data-line="70"></span> v<span data-line="70"></span><sub>n</sub><span data-line="70"></span>) ]<span data-line="70"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="70"></span> </td><td class="tbody tr-odd col cell-border-right col-even col-last" data-line="70" data-row="3" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="70"></span> Sends to machine expression dst event expression ev (with payload to (v<span data-line="70"></span><sub>1</sub><span data-line="70"></span>, <span data-line="70"></span>&#8230;<span data-line="70"></span>, v<span data-line="70"></span><sub>n</sub><span data-line="70"></span>)).                                                            </td></tr>
<tr><td class="tbody tr-even col cell-border-left col-odd col-first" data-line="71" data-row="4" data-col="1" style="text-align:left"><span data-line="71"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>pop</span></code><span data-line="71"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="71"></span>                                  </td><td class="tbody tr-even col cell-border-right col-even col-last" data-line="71" data-row="4" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="71"></span> Pops this state from the state stack and returns to the parent state. Fails if the state stack is empty and the trigger is not the <span data-line="71"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>halt</span></code><span data-line="71"></span> event.</td></tr>
<tr><td class="tbody tr-odd tr-last col cell-border-left col-odd col-first" data-line="72" data-row="5" data-col="1" style="text-align:left"><span data-line="72"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>assert</span></code><span data-line="72"></span> v<span data-line="72"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token delimiter psharp'>;</span></code><span data-line="72"></span>                             </td><td class="tbody tr-odd tr-last col cell-border-right col-even col-last" data-line="72" data-row="5" data-col="2" style="vertical-align:top;width:60%;text-align:left"><span data-line="72"></span> Fails if the expression v does not evaluate to <span data-line="72"></span><code class="code code1 language-text/psharp lang-text/psharp text/psharp highlighted" ><span class='token keyword psharp'>true</span></code><span data-line="72"></span>.                                                                                          </td></tr>
<tr><td class="tbody tr-odd col cell-border-left cell-line col-odd col-first" data-line="73" data-row="5" data-col="1" style="text-align:left"></td><td class="tbody tr-odd col cell-border-right cell-line col-even col-last" data-line="73" data-row="5" data-col="2" style="vertical-align:top;width:60%;text-align:left"></td></tr></tbody></table></div>
<div class="logomadoko block" style="text-align:right;font-size:xx-small;margin-top:4em"><span data-line="1"></span>Created with&nbsp;<a href="https://www.madoko.net">Madoko.net</a>.</div></div><span data-line=""></span>
</body>

</html>
